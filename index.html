<html>
	<head>
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				background:#fff;
				padding:0;
				margin:0;
				font-weight: bold;
				overflow:hidden;
			}
		</style>
	</head>
	<body>
		<script src="three/three.js"></script>
		<script src="three-wasm.js"></script>
		<script src="libs/stats.min.js"></script>
		<script src="libs/dat.gui.min.js"></script>

		<script>

			var useWasm = true;
			var objectNum = 1000;
			var animationEnabled = true;
			var query = location.href.split( '?' )[ 1 ];

			if ( query ) {

				var queryArray = query.split( '&' );

				for ( var i = 0, il = queryArray.length; i < il; i ++ ) {

					var params = queryArray[ i ].split( '=' );
					var name = params[ 0 ].toLowerCase();
					var value = params[ 1 ];

					switch( name ) {

						case 'num':
							objectNum = parseInt( value );
							break;

						case 'javascript':
							useWasm = ! ( value === 'true' || value === '1' );
							break;

						case 'animation':
							animationEnabled = value === 'true' || value === '1';
							break;

						default:
							console.error( 'Unknown option: ' + name );

					}

				}

			}

			setTimeout( function () {

				initGui();
				initModule();
				if ( useWasm ) initThree();
				init();
				animate();

			}, 1000 );

			var renderer, scene, camera;
			var stats = new Stats();

			document.body.appendChild( stats.dom );

			var mouseX = 0, mouseY = 0;
			var windowHalfX = window.innerWidth / 2.0;
			var windowHalfY = window.innerHeight / 2.0;

			document.addEventListener( 'mousemove', onDocumentMouseMove, false );

			function initGui() {

				var gui = new dat.GUI();

				var api = {
					'platform': useWasm ? 'wasm' : 'JavaScript',
					'num': objectNum,
					'animation': animationEnabled,
					'update': function () {
						location.href = '?num=' + api.num + '&javascript=' + ( api.platform === 'JavaScript' ) + '&animation=' + api.animation;
					}
				};

				gui.add( api, 'platform', [ 'wasm', 'JavaScript' ] );
				gui.add( api, 'num', 1, 10000, 1 );
				gui.add( api, 'animation' );
				gui.add( api, 'update' );

			}

			function initModule() {

				console.log( Module );

				Module.functions = {};

				Module.functions.sizeOfVector3 = Module.cwrap(
					'sizeOfVector3',
					'number',
					[]
				);

				Module.functions.sizeOfBufferAttribute = Module.cwrap(
					'sizeOfBufferAttribute',
					'number',
					[]
				);

				Module.functions.sizeOfBufferGeometry = Module.cwrap(
					'sizeOfBufferGeometry',
					'number',
					[]
				);

				Module.functions.sizeOfObject3D = Module.cwrap(
					'sizeOfObject3D',
					'number',
					[]
				);

				Module.functions.sizeOfMesh = Module.cwrap(
					'sizeOfMesh',
					'number',
					[]
				);

				Module.functions.sizeOfMeshBasicMaterial = Module.cwrap(
					'sizeOfMeshBasicMaterial',
					'number',
					[]
				);

				Module.functions.sizeOfScene = Module.cwrap(
					'sizeOfScene',
					'number',
					[]
				);

				Module.functions.sizeOfPerspectiveCamera = Module.cwrap(
					'sizeOfPerspectiveCamera',
					'number',
					[]
				);

				Module.functions.sizeOfWebGLRenderer = Module.cwrap(
					'sizeOfWebGLRenderer',
					'number',
					[]
				);

				Module.functions.Vector3_init = Module.cwrap(
					'Vector3_init',
					'number',
					['number', 'number', 'number', 'number']
				);

				Module.functions.BufferAttribute_init = Module.cwrap(
					'BufferAttribute_init',
					'number',
					['number', 'number', 'number', 'number', 'number']
				);

				Module.functions.BufferGeometry_init = Module.cwrap(
					'BufferGeometry_init',
					'number',
					['number']
				);

				Module.functions.BufferGeometry_setIndex = Module.cwrap(
					'BufferGeometry_setIndex',
					'number',
					['number', 'number']
				);

				Module.functions.BufferGeometry_addAttribute = Module.cwrap(
					'BufferGeometry_addAttribute',
					'number',
					['number', 'number', 'number']
				);

				Module.functions.Object3D_init = Module.cwrap(
					'Object3D_init',
					'number',
					['number']
				);

				Module.functions.Mesh_init = Module.cwrap(
					'Mesh_init',
					'number',
					['number', 'number', 'number']
				);

				Module.functions.MeshBasicMaterial_init = Module.cwrap(
					'MeshBasicMaterial_init',
					'number',
					['number', 'number']
				);

				Module.functions.Object3D_add = Module.cwrap(
					'Object3D_add',
					'number',
					['number', 'number']
				);

				Module.functions.Object3D_getPositionPointer = Module.cwrap(
					'Object3D_getPositionPointer',
					'number',
					['number']
				);

				Module.functions.Scene_init = Module.cwrap(
					'Scene_init',
					'number',
					['number']
				);

				Module.functions.PerspectiveCamera_init = Module.cwrap(
					'PerspectiveCamera_init',
					'number',
					['number']
				);

				Module.functions.WebGLRenderer_init = Module.cwrap(
					'WebGLRenderer_init',
					'number',
					[ 'number', 'number' ]
				);

				Module.functions.WebGLRenderer_setSize = Module.cwrap(
					'WebGLRenderer_setSize',
					'number',
					[ 'number', 'number' ]
				);

				Module.functions.WebGLRenderer_clearColor = Module.cwrap(
					'WebGLRenderer_clearColor',
					'void',
					[ 'number', 'number', 'number', 'number', 'number' ]
				);

				Module.functions.WebGLRenderer_render = Module.cwrap(
					'WebGLRenderer_render',
					'void',
					[ 'number', 'number' ]
				);

			}

			function initThree() {

				THREE.Object3D.prototype.init = function () {

					this.pointer = Module._malloc( Module.functions.sizeOfObject3D() );
					Module.functions.Object3D_init( this.pointer );
					this.mapWasm();

				};

				THREE.Object3D.prototype.mapWasm = function () {

					var pointer = this.pointer;
					var buffer = Module.HEAPU8.buffer;

					var offset = Module.functions.Object3D_getPositionPointer( pointer );

					var position = new Float64Array( buffer, offset, 3 );
					offset += 3 * 8;

					var quaternion = new Float64Array( buffer, offset, 4 );
					offset += 4 * 8;

					var scale = new Float64Array( buffer, offset, 4 );
					offset += 3 * 6;

					Object.defineProperties( this.position, {

						x: {

							get: function () {

								return position[ 0 ];

							},

							set: function ( value ) {

								position[ 0 ] = value;

							}

						},

						y: {

							get: function () {

								return position[ 1 ];

							},

							set: function ( value ) {

								position[ 1 ] = value;

							}

						},

						z: {

							get: function () {

								return position[ 2 ];

							},

							set: function ( value ) {

								position[ 2 ] = value;

							}

						}

					} );

					Object.defineProperties( this.quaternion, {

						_x: {

							get: function () {

								return quaternion[ 0 ];

							},

							set: function ( value ) {

								quaternion[ 0 ] = value;

							}

						},

						_y: {

							get: function () {

								return quaternion[ 1 ];

							},

							set: function ( value ) {

								quaternion[ 1 ] = value;

							}

						},

						_z: {

							get: function () {

								return quaternion[ 2 ];

							},

							set: function ( value ) {

								quaternion[ 2 ] = value;

							}

						},

						_w: {

							get: function () {

								return quaternion[ 3 ];

							},

							set: function ( value ) {

								quaternion[ 3 ] = value;

							}

						}

					} );

					Object.defineProperties( this.scale, {

						x: {

							get: function () {

								return scale[ 0 ];

							},

							set: function ( value ) {

								scale[ 0 ] = value;

							}

						},

						y: {

							get: function () {

								return scale[ 1 ];

							},

							set: function ( value ) {

								scale[ 1 ] = value;

							}

						},

						z: {

							get: function () {

								return scale[ 2 ];

							},

							set: function ( value ) {

								scale[ 2 ] = value;

							}

						}

					} );

				}

				THREE.Object3D.prototype._add = THREE.Object3D.prototype.add;
				THREE.Object3D.prototype.add = function ( child ) {

					this._add( child );
					Module.functions.Object3D_add( this.pointer, child.pointer );
					return this;

				};

				THREE.Mesh.prototype.init = function () {

					this.pointer = Module._malloc( Module.functions.sizeOfMesh() );
					Module.functions.Mesh_init( this.pointer, this.geometry.pointer, this.material.pointer );
					this.mapWasm();

				};

				THREE.Scene.prototype.init = function () {

					this.pointer = Module._malloc( Module.functions.sizeOfScene() );
					Module.functions.Scene_init( this.pointer );
					this.mapWasm();

				};

				THREE.PerspectiveCamera.prototype.init = function () {

					this.pointer = Module._malloc( Module.functions.sizeOfPerspectiveCamera() );
					Module.functions.PerspectiveCamera_init( this.pointer, this.fov, this.aspect, this.near, this.far );
					this.mapWasm();

				};

				THREE.MeshBasicMaterial.prototype.init = function () {

					var vector3Pointer = Module._malloc( Module.functions.sizeOfVector3() );
					var vector3Array = new Float64Array( Module.HEAPU8.buffer, vector3Pointer, 3 );
					this.color.toArray( vector3Array );
					this.pointer = Module._malloc( Module.functions.sizeOfMeshBasicMaterial() );
					Module.functions.MeshBasicMaterial_init( this.pointer, vector3Pointer );
					Module._free( vector3Pointer );

				};

				THREE.BufferAttribute.prototype.init = function () {

					this.pointer = Module._malloc( Module.functions.sizeOfBufferAttribute() );
					var arrayPointer = Module._malloc( this.array.byteLength );
					var typedArray = new this.array.constructor( Module.HEAPU8.buffer, arrayPointer, this.array.length );
					typedArray.set( this.array );
					Module.functions.BufferAttribute_init(
						this.pointer,
						arrayPointer,
						this.array.constructor === Float32Array ? 0 : 1,
						this.array.byteLength,
						this.itemSize
					);

				};

				THREE.BufferGeometry.prototype.init = function () {

					this.pointer = Module._malloc( Module.functions.sizeOfBufferGeometry() );
					Module.functions.BufferGeometry_init( this.pointer );

				};

				THREE.BufferGeometry.prototype._addAttribute = THREE.BufferGeometry.prototype.addAttribute;
				THREE.BufferGeometry.prototype.addAttribute = function ( name, attribute ) {

					this._addAttribute( name, attribute );

					if ( name !== 'position' ) return; // Currently support only position.

					Module.functions.BufferGeometry_addAttribute( this.pointer, stringsToPointer( name ), attribute.pointer );
					return this;

				};

				THREE.BufferGeometry.prototype._setIndex = THREE.BufferGeometry.prototype.setIndex;
				THREE.BufferGeometry.prototype.setIndex = function ( index ) {

					this._setIndex( index );
					Module.functions.BufferGeometry_setIndex( this.pointer, this.index.pointer );
					return this;

				};

				THREE.WebGLRenderer = function ( params ) {

					params = params || {};

					var canvas = params.canvas;
					var id = canvas.id;

					this.pointer = Module._malloc( Module.functions.sizeOfWebGLRenderer() );
					Module.functions.WebGLRenderer_init( this.pointer, stringsToPointer( id ) );

				}

				Object.assign( THREE.WebGLRenderer.prototype, {

					setClearColor( color, alpha ) {

						Module.functions.WebGLRenderer_clearColor( this.pointer, color.r, color.g, color.b, alpha );
						return this;

					},

					setSize: function ( width, height ) {

						Module.functions.WebGLRenderer_setSize( this.pointer, width, height );
						return this;

					},

					render: function ( scene, camera ) {

						Module.functions.WebGLRenderer_render( this.pointer, scene.pointer, camera.pointer );
						return this;

					}

				}  );

			}

			function stringsToPointer( str ) {

				var pointer = Module._malloc( str.length + 1 );
				Module.stringToUTF8( str, pointer, str.length + 1 );
				return pointer;

			}

			function init() {

				var id = 'wasmCanvas';
				var width = window.innerWidth;
				var height = window.innerHeight;
				var canvas = document.createElement( 'canvas' );
				canvas.id = id;
				canvas.width = width;
				canvas.height = height;
				document.body.appendChild( canvas );

				renderer = new THREE.WebGLRenderer( {
					canvas: canvas
				} );
				renderer.setSize( width, height );
				renderer.setClearColor( new THREE.Color( 0xffffff ), 1.0 );

				scene = new THREE.Scene();

				camera = new THREE.PerspectiveCamera( 60, width / height, 1.0, 2000 );
				camera.position.z = 50.0;

				var geometrySize = 2.0;

				var geometries = [
					new THREE.BoxBufferGeometry( geometrySize, geometrySize, geometrySize ),
					new THREE.CylinderBufferGeometry( geometrySize, geometrySize, geometrySize ),
					new THREE.SphereBufferGeometry( geometrySize )
				];

				for ( var i = 0; i < objectNum; i ++ ) {

					var color = new THREE.Color();
					color.r = Math.random();
					color.g = Math.random();
					color.b = Math.random();

					var mesh = new THREE.Mesh(
						geometries[ i % geometries.length ],
						new THREE.MeshBasicMaterial( { color: color } )
					);
					mesh.position.x = Math.random() * 50.0 - 25.0;
					mesh.position.y = Math.random() * 50.0 - 25.0;
					mesh.position.z = Math.random() * 50.0 - 25.0;
					mesh.rotation.y = Math.random() * 2.0 * Math.PI;
					mesh.rotation.z = Math.random() * 2.0 * Math.PI;
					mesh.scale.x = mesh.scale.y = mesh.scale.z = Math.random() * 0.5 + 0.5;
					scene.add( mesh );

				}

			}

			function onDocumentMouseMove( event ) {

				mouseX = ( event.clientX - windowHalfX ) * 0.01;
				mouseY = ( event.clientY - windowHalfY ) * 0.01;

			}

			function animate() {

				requestAnimationFrame( animate );

				camera.position.x += ( mouseX - camera.position.x ) * 0.05;
				camera.position.y += ( - mouseY - camera.position.y ) * 0.05;
				camera.lookAt( scene.position );

				//scene.rotation.x += 0.002;
				//scene.rotation.y += 0.004;

				if ( animationEnabled ) {

					for ( var i = 0, il = scene.children.length; i < il; i ++ ) {

						var child = scene.children[ i ];
						child.rotation.x += 0.02;
						child.rotation.y += 0.04;

					}

				}

				renderer.render( scene, camera );

				stats.update();

			}

		</script>
	</body>
</html>
